var Canvas2Image=function(){var t,e,n={canvas:!!(e=(t=document.createElement("canvas")).getContext("2d")),imageData:!!e.getImageData,dataURL:!!t.toDataURL,btoa:!!window.btoa},a="image/octet-stream";function r(t,e,n){var a=t.width,r=t.height;null==e&&(e=a),null==n&&(n=r);var o=document.createElement("canvas"),i=o.getContext("2d");return o.width=e,o.height=n,i.drawImage(t,0,0,a,r,0,0,e,n),o}function o(t,e,n,a){return(t=r(t,n,a)).toDataURL(e)}function i(t,e){var n=document.createElement("a");n.href=t,n.download=e;var a=new MouseEvent("click",{bubbles:!1,cancelable:!1});n.dispatchEvent(a)}function u(t){var e=document.createElement("img");return e.src=t,e}function c(t){return"image/"+(t=t.toLowerCase().replace(/jpg/i,"jpeg")).match(/png|jpeg|bmp|gif/)[0]}function g(t){if(!window.btoa)throw"btoa undefined";var e="";if("string"==typeof t)e=t;else for(var n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return btoa(e)}function f(t){var e=t.width,n=t.height;return t.getContext("2d").getImageData(0,0,e,n)}function m(t,e){return"data:"+e+";base64,"+t}var v=function(t){var e=t.width,n=t.height,a=e*n*3,r=a+54,o=[66,77,255&r,r>>8&255,r>>16&255,r>>24&255,0,0,0,0,54,0,0,0],i=[40,0,0,0,255&e,e>>8&255,e>>16&255,e>>24&255,255&n,n>>8&255,n>>16&255,n>>24&255,1,0,24,0,0,0,0,0,255&a,a>>8&255,a>>16&255,a>>24&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],u=(4-3*e%4)%4,c=t.data,f="",m=e<<2,v=n,d=String.fromCharCode;do{for(var l=m*(v-1),s="",h=0;h<e;h++){var p=h<<2;s+=d(c[l+p+2])+d(c[l+p+1])+d(c[l+p])}for(var b=0;b<u;b++)s+=String.fromCharCode(0);f+=s}while(--v);return g(o.concat(i))+g(f)},d=function(t,e,u,g,d){if(n.canvas&&n.dataURL){"string"==typeof t&&(t=document.getElementById(t)),null==g&&(g="png");var l=d3.timeFormat("%Y%m%d_%H%M%S")(new Date);if(d=null==d||0===d.length?"Data_Wow_"+l+"."+g:d+l+"."+g,g=c(g),/bmp/.test(g)){var s=f(r(t,e,u));i(m(v(s),a),d)}else i(o(t,g,e,u).replace(g,a),d)}},l=function(t,e,a,i){if(n.canvas&&n.dataURL){if("string"==typeof t&&(t=document.getElementById(t)),null==i&&(i="png"),i=c(i),/bmp/.test(i)){var g=f(r(t,e,a));return u(m(v(g),"image/bmp"))}return u(o(t,i,e,a))}};return{saveAsImage:d,saveAsPNG:function(t,e,n,a){return d(t,e,n,"png",a)},saveAsJPEG:function(t,e,n,a){return d(t,e,n,"jpeg",a)},saveAsGIF:function(t,e,n,a){return d(t,e,n,"gif",a)},saveAsBMP:function(t,e,n,a){return d(t,e,n,"bmp",a)},convertToImage:l,convertToPNG:function(t,e,n){return l(t,e,n,"png")},convertToJPEG:function(t,e,n){return l(t,e,n,"jpeg")},convertToGIF:function(t,e,n){return l(t,e,n,"gif")},convertToBMP:function(t,e,n){return l(t,e,n,"bmp")}}}();